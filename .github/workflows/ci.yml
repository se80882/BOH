name: CI/CD - è‡ªåŠ¨åŒ–æµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  python-tests:
    name: Pythonæµ‹è¯•
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: å®‰è£…Playwrightæµè§ˆå™¨
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: è¿è¡ŒPythonæµ‹è¯•
      run: |
        python -m pytest tests/test_login.py -v --html=playwright-report/python-test-report.html --self-contained-html
      env:
        CI: true
      continue-on-error: false
    
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-test-report-${{ matrix.python-version }}
        path: |
          playwright-report/python-test-report.html
          test-results/
        retention-days: 30
    
    - name: ä¸Šä¼ æµ‹è¯•è§†é¢‘
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-test-videos-${{ matrix.python-version }}
        path: test-results/**/*.webm
        retention-days: 7

  javascript-tests:
    name: JavaScriptæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: å®‰è£…Playwrightæµè§ˆå™¨
      run: npx playwright install --with-deps chromium
    
    - name: è¿è¡ŒJavaScriptæµ‹è¯•
      run: npm test
      env:
        CI: true
    
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: javascript-test-report
        path: |
          playwright-report/
          test-results/
        retention-days: 30

  test-summary:
    name: æµ‹è¯•æ€»ç»“
    needs: [python-tests, javascript-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æµ‹è¯•ç»“æžœæ€»ç»“
      run: |
        echo "## ðŸ§ª æµ‹è¯•æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Pythonæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å·²åœ¨å¤šä¸ªPythonç‰ˆæœ¬ä¸Šè¿è¡Œæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### JavaScriptæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å·²è¿è¡ŒJavaScript/Node.jsæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š è¯¦ç»†æµ‹è¯•æŠ¥å‘Šè¯·æŸ¥çœ‹Artifacts" >> $GITHUB_STEP_SUMMARY

