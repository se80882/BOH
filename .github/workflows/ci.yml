name: CI/CD - Pythonè‡ªåŠ¨åŒ–æµ‹è¯•

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  python-tests:
    name: Pythonæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: å®‰è£…Playwrightæµè§ˆå™¨
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: è¿è¡ŒPythonæµ‹è¯•
      run: |
        python -m pytest tests/test_login.py -v --alluredir=allure-results
      env:
        CI: true
      continue-on-error: false
    
    - name: å®‰è£…Allureå‘½ä»¤è¡Œå·¥å…·
      run: |
        wget -qO- https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz | tar -xz
        sudo mv allure-2.24.0 /opt/allure
        sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
    
    - name: ç”ŸæˆAllureæŠ¥å‘Š
      run: |
        allure generate allure-results -o allure-report --clean || true
      continue-on-error: true
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…Node.jsä¾èµ–
      run: npm install
    
    - name: ä¿®å¤AllureæŠ¥å‘Šï¼ˆæ”¯æŒfile://åè®®ï¼‰
      run: npm run allure:fix
      continue-on-error: true
    
    - name: ä¸Šä¼ AllureæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-report
        path: |
          allure-results/
          allure-report/
        retention-days: 30
    
    - name: ä¸Šä¼ æµ‹è¯•è§†é¢‘
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-videos
        path: test-results/**/*.webm
        retention-days: 7
    
    - name: ä¸Šä¼ å¤±è´¥æˆªå›¾
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-screenshots
        path: test-results/**/*.png
        retention-days: 7
    
    - name: æµ‹è¯•ç»“æžœæ€»ç»“
      if: always()
      run: |
        echo "## ðŸ§ª Pythonæµ‹è¯•æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### æµ‹è¯•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- âœ… æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š è¯¦ç»†æµ‹è¯•æŠ¥å‘Šå’Œè§†é¢‘è¯·æŸ¥çœ‹Artifacts" >> $GITHUB_STEP_SUMMARY

