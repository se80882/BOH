name: 定时测试

on:
  schedule:
    # 每2小时执行一次，从凌晨0点开始（UTC时间）
    # 执行时间：0:00, 2:00, 4:00, 6:00, 8:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00
    - cron: '0 */2 * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  scheduled-tests:
    name: 定时执行测试
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 安装Playwright浏览器
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: 运行Python测试
      run: |
        python -m pytest tests/test_login.py -v
      env:
        CI: true
    
    - name: 安装Allure命令行工具
      run: |
        wget -qO- https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz | tar -xz
        sudo mv allure-2.24.0 /opt/allure
        sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
    
    - name: 生成Allure报告
      run: |
        allure generate allure-results -o allure-report --clean || true
      continue-on-error: true
    
    - name: 上传Allure报告
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scheduled-allure-report
        path: |
          allure-results/
          allure-report/
        retention-days: 30

