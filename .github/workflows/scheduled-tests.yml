name: 定时测试

on:
  schedule:
    # 每1小时执行一次，从每小时的第0分钟开始（UTC时间）
    # cron格式: 分钟 小时 日 月 星期
    # 执行时间：0:00, 1:00, 2:00, 3:00, ..., 23:00（每天24次）
    - cron: '0 * * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  scheduled-tests:
    name: 定时执行测试
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 安装Python依赖
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 安装Playwright浏览器
      run: |
        playwright install chromium
        playwright install-deps chromium
    
    - name: 运行Python测试
      run: |
        python -m pytest tests/test_login.py -v --alluredir=allure-results
      env:
        CI: true
    
    - name: 安装Allure命令行工具
      run: |
        wget -qO- https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz | tar -xz
        sudo mv allure-2.24.0 /opt/allure
        sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
    
    - name: 生成Allure报告
      run: |
        allure generate allure-results -o allure-report --clean || true
      continue-on-error: true
    
    - name: 设置Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: 安装Node.js依赖
      run: npm install
    
    - name: 修复Allure报告（支持file://协议）
      run: npm run allure:fix
      continue-on-error: true
    
    - name: 上传Allure报告
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: scheduled-allure-report
        path: |
          allure-results/
          allure-report/
        retention-days: 30

